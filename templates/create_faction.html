<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Faction</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h2>Create Faction for <strong>{{ campaign.name }}</strong></h2>

        {% if error_message %}
            <div class="alert alert-danger">{{ error_message }}</div>
        {% endif %}

        <form method="POST">
            <!-- Master Faction Selector -->
            <div class="mb-3">
                <label for="master_faction_id" class="form-label">Use Existing Master Faction (optional)</label>
                <select class="form-select" name="master_faction_id" id="master_faction_id" onchange="this.form.submit()">
                    <option value="">-- Select Master Faction --</option>
                    {% for mf in master_factions %}
                        {% set used = false %}
                        {% for f in campaign.factions %}
                            {% if f.name == mf.name %}
                                {% set used = true %}
                            {% endif %}
                        {% endfor %}
                        <option value="{{ mf.id }}"
                            {% if form_data.master_faction_id == mf.id|string %}selected{% endif %}
                            {% if used %}disabled{% endif %}>
                            {{ mf.name }} {% if mf.source %}({{ mf.source }}){% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <hr>

            <h5><strong>Or create a new faction:</strong></h5>

            <div class="mb-3">
                <label for="name" class="form-label">Faction Name</label>
                <input type="text" class="form-control {% if error_message %}is-invalid{% endif %}" id="name" name="name" value="{{ form_data.name if form_data else '' }}" required>
                {% if error_message %}
                    <div class="invalid-feedback">
                        A faction with that name already exists in this campaign.
                    </div>
                {% endif %}
            </div>

            <div class="mb-3">
                <label for="summary" class="form-label">Summary</label>
                <textarea class="form-control" id="summary" name="summary">{{ form_data.summary if form_data else '' }}</textarea>
            </div>

            <div class="mb-3">
                <label for="faction_type" class="form-label">Faction Type</label>
                <select class="form-select" id="faction_type" name="faction_type">
                    {% for option in faction_type_list %}
                        <option value="{{ option }}" {% if form_data.faction_type == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="base_location" class="form-label">Base of Operations</label>
                <input type="text" class="form-control" id="base_location" name="base_location" value="{{ form_data.base_location if form_data else '' }}">
            </div>

            <div class="mb-3">
                <label for="alignment" class="form-label">Alignment</label>
                <select class="form-select" id="alignment" name="alignment">
                    {% for option in alignment_list %}
                        <option value="{{ option }}" {% if form_data.alignment == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="leader_name" class="form-label">Leader Name</label>
                <input type="text" class="form-control" id="leader_name" name="leader_name" value="{{ form_data.leader_name if form_data else '' }}">
            </div>

            <div class="mb-3">
                <label for="source" class="form-label">Source (optional)</label>
                <input type="text" class="form-control" id="source" name="source" placeholder="e.g. Waterdeep: Dragon Heist" value="{{ form_data.source if form_data else '' }}">
            </div>

            <div class="d-flex gap-3">
                <button type="submit" class="btn btn-primary">Create Faction</button>
                <a href="{{ url_for('create_npc', campaign_id=campaign.id) }}" class="btn btn-outline-secondary">Skip to NPCs</a>
            </div>
        </form>
    </div>
</body>
</html>
